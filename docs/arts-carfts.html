<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Piecemeal R</title>
  <meta name="description" content="This is a R tutorial.">
  <meta name="generator" content="bookdown 0.3.14 and GitBook 2.6.7">

  <meta property="og:title" content="Piecemeal R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a R tutorial." />
  <meta name="github-repo" content="/kotamine/piecemealR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Piecemeal R" />
  
  <meta name="twitter:description" content="This is a R tutorial." />
  

<meta name="author" content="Kota Minegishi">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="materials.html">
<link rel="next" href="huning-down-numbers.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.8/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Piecemeal R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="a-few-words.html"><a href="a-few-words.html"><i class="fa fa-check"></i><b>1.1</b> A Few Words</a></li>
<li class="chapter" data-level="1.2" data-path="materials.html"><a href="materials.html"><i class="fa fa-check"></i><b>1.2</b> Materials</a></li>
<li class="chapter" data-level="1.3" data-path="arts-carfts.html"><a href="arts-carfts.html"><i class="fa fa-check"></i><b>1.3</b> Arts &amp; Carfts</a><ul>
<li class="chapter" data-level="" data-path="arts-carfts.html"><a href="arts-carfts.html#crafts"><i class="fa fa-check"></i>Crafts</a></li>
<li class="chapter" data-level="" data-path="arts-carfts.html"><a href="arts-carfts.html#arts"><i class="fa fa-check"></i>Arts</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="huning-down-numbers.html"><a href="huning-down-numbers.html"><i class="fa fa-check"></i><b>1.4</b> Huning down numbers</a></li>
<li class="chapter" data-level="1.5" data-path="reflections.html"><a href="reflections.html"><i class="fa fa-check"></i><b>1.5</b> Reflections</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="essentials.html"><a href="essentials.html"><i class="fa fa-check"></i><b>2</b> Essentials</a><ul>
<li class="chapter" data-level="2.1" data-path="cheatsheets.html"><a href="cheatsheets.html"><i class="fa fa-check"></i><b>2.1</b> Cheatsheets</a></li>
<li class="chapter" data-level="2.2" data-path="data-types.html"><a href="data-types.html"><i class="fa fa-check"></i><b>2.2</b> Data types</a><ul>
<li class="chapter" data-level="" data-path="data-types.html"><a href="data-types.html#atomic"><i class="fa fa-check"></i>Atomic</a></li>
<li class="chapter" data-level="" data-path="data-types.html"><a href="data-types.html#factor"><i class="fa fa-check"></i>Factor</a></li>
<li class="chapter" data-level="" data-path="data-types.html"><a href="data-types.html#matrix"><i class="fa fa-check"></i>Matrix</a></li>
<li class="chapter" data-level="" data-path="data-types.html"><a href="data-types.html#data-frame"><i class="fa fa-check"></i>Data Frame</a></li>
<li class="chapter" data-level="" data-path="data-types.html"><a href="data-types.html#list"><i class="fa fa-check"></i>List</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i><b>2.3</b> Programming</a><ul>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#operator"><i class="fa fa-check"></i>Operator</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#if-else"><i class="fa fa-check"></i>If else</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#loop"><i class="fa fa-check"></i>Loop</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#function"><i class="fa fa-check"></i>Function</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#environment"><i class="fa fa-check"></i>Environment</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#debugging"><i class="fa fa-check"></i>Debugging</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#stat-func."><i class="fa fa-check"></i>Stat func.</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#string-func."><i class="fa fa-check"></i>String func.</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#set-func."><i class="fa fa-check"></i>Set func.</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="housekeeping.html"><a href="housekeeping.html"><i class="fa fa-check"></i><b>2.4</b> Housekeeping</a><ul>
<li class="chapter" data-level="" data-path="housekeeping.html"><a href="housekeeping.html#working-directory"><i class="fa fa-check"></i>Working directory</a></li>
<li class="chapter" data-level="" data-path="housekeeping.html"><a href="housekeeping.html#r-session"><i class="fa fa-check"></i>R session</a></li>
<li class="chapter" data-level="" data-path="housekeeping.html"><a href="housekeeping.html#save-load"><i class="fa fa-check"></i>Save &amp; load</a></li>
<li class="chapter" data-level="" data-path="housekeeping.html"><a href="housekeeping.html#input-output"><i class="fa fa-check"></i>Input &amp; Output</a></li>
<li class="chapter" data-level="" data-path="housekeeping.html"><a href="housekeeping.html#updating"><i class="fa fa-check"></i>Updating</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="good-to-knows.html"><a href="good-to-knows.html"><i class="fa fa-check"></i><b>3</b> Good-to-Knows</a></li>
<li class="chapter" data-level="4" data-path="piecemeal-top.html"><a href="piecemeal-top.html"><i class="fa fa-check"></i><b>4</b> Piecemeal Topics</a><ul>
<li class="chapter" data-level="4.1" data-path="dplyr.html"><a href="dplyr.html"><i class="fa fa-check"></i><b>4.1</b> Unusual Deaths in Mexico</a><ul>
<li class="chapter" data-level="" data-path="dplyr.html"><a href="dplyr.html#materials-1"><i class="fa fa-check"></i>Materials</a></li>
<li class="chapter" data-level="" data-path="dplyr.html"><a href="dplyr.html#arts-crafts"><i class="fa fa-check"></i>Arts &amp; Crafts</a></li>
<li class="chapter" data-level="" data-path="dplyr.html"><a href="dplyr.html#exercise"><i class="fa fa-check"></i>Exercise</a></li>
<li class="chapter" data-level="" data-path="dplyr.html"><a href="dplyr.html#the-key"><i class="fa fa-check"></i>The Key</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="next.html"><a href="next.html"><i class="fa fa-check"></i><b>4.2</b> Upcoming topics</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i><b>5</b> Resources</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/yihui/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Piecemeal R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="arts-carfts" class="section level2">
<h2><span class="header-section-number">1.3</span> Arts &amp; Carfts</h2>
<div id="crafts" class="section level3 unnumbered">
<h3>Crafts</h3>
<p>Let’s look at the six types of data wrangling functions in the <code>dplyr</code> package.</p>
<ul>
<li><p><code>filter()</code>: subsets rows (e.g. observations) in a data frame. We put in logical vector(s).</p></li>
<li><p><code>select()</code>: subsets columns (e.g. variables) in a data frame. We put in column name(s).</p></li>
<li><p><code>arrange()</code>: orders rows in a data frame. We put in column names(s).</p></li>
<li><p><code>summarise()</code>: collapses a data frame into a row(s) of summary statistics. We put in <strong>summary functions</strong> (e.g. statistics functions) using column names.</p></li>
<li><p><code>mutate()</code>: creates a new variable(s) and adds it to the existing columns. We put in <strong>window functions</strong> (e.g. transforming operations) using column names.</p></li>
<li><p><code>group_by()</code>: assigns rows into groups in a data frame. We put in column name(s).</p></li>
</ul>
<p>The first argument in all these functions is <em>a data frame</em>, and by knowing this we can easily <em>pipe</em> a sequence of data operations through <code>%&gt;%</code> operator. For example, we want to find average delays in departures and arrivals from New York to St. Paul-Minneapolis airport (MSP). We can take the flight data frame, apply <code>filter()</code> to subset rows into the flights to MSP, and then apply <code>summarise()</code> to calculate the mean statistics. Note that this involves a sequence of data operations, and one can translate it into codes by inserting <code>%&gt;%</code> operator that reads as <em>then</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights %&gt;%<span class="st">  </span><span class="co"># take the flights data frame, then</span>
<span class="st">  </span><span class="kw">filter</span>(dest ==<span class="st"> &quot;MSP&quot;</span>) %&gt;%<span class="st">  </span><span class="co"># filter rows, then  </span>
<span class="st">  </span><span class="kw">summarise</span>(   
    <span class="co"># summarise departure and arrival delays into their means and call them mean_dep_delay and mean_arr_delay </span>
    <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), 
    <span class="dt">mean_arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
    )    <span class="co"># calculate the mean, while removing NA values  </span></code></pre></div>
<pre><code>## # A tibble: 1 × 2
##   mean_dep_delay mean_arr_delay
##            &lt;dbl&gt;          &lt;dbl&gt;
## 1       13.32481       7.270169</code></pre>
<p>The <code>=</code> symbol in the <code>summarise()</code> function is used as a column name assignment for the summarized data, and the two arguments inside <code>summarise()</code> are parallel operations, which in this case are the mean function applied to different variables. In <code>summarise()</code>, one can use <strong>summary functions</strong> that takes a vector and outputs a single value.</p>
<p>Each time we apply <code>%&gt;%</code> operator above, we pass a modified data frame from one data operation to another through the first argument. This code is equivalent to</p>
<pre><code>## # A tibble: 1 × 2
##   mean_dep_delay mean_arr_delay
##            &lt;dbl&gt;          &lt;dbl&gt;
## 1       13.32481       7.270169</code></pre>
<p>You will quickly learn that <code>%&gt;%</code> operator makes the code much easier to read, write, and edit and why that is so important.</p>
<p>Let’s add a few more lines to the above example. Say, we want to see the average delays by carrier and sort the results by the number of observations (e.g. flights) in descending order.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flight_stats_MSP &lt;-<span class="st"> </span>flights %&gt;%<span class="st">  </span><span class="co"># assign the results in an object named &quot;flight_stats&quot;</span>
<span class="st">  </span><span class="kw">filter</span>(dest ==<span class="st"> &quot;MSP&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(carrier) %&gt;%<span class="st">  </span><span class="co">#  group rows by carrier </span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">n_obs =</span> <span class="kw">n</span>(),  <span class="co"># count number of rows </span>
    <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
    <span class="dt">mean_arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  ) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n_obs))  <span class="co"># sort by n_obs in descending order</span>

flight_stats_MSP  <span class="co"># show flight_stats object</span></code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   carrier n_obs mean_dep_delay mean_arr_delay
##     &lt;chr&gt; &lt;int&gt;          &lt;dbl&gt;          &lt;dbl&gt;
## 1      DL  2864      10.651392       4.035702
## 2      EV  1773      17.093413      10.527995
## 3      MQ  1293       8.255457       9.559350
## 4      9E  1249      19.658113       8.089776
## 5      OO     4       0.750000      -2.000000
## 6      UA     2      -6.000000      -5.500000</code></pre>
<p>Carrier variable is expressed in International Air Transportation Association (IATA) code, so let’s add a column by joining a data frame called “airlines” that contains information on IATA codes and airline names. In Rstudio, you can find the airlines data frame under <strong>Environment</strong> tab (in the upper right corner) by switching the display option from <em>Global Environment</em> to <em>package:nycflights13</em>. To inspect the data frame, type <code>View(airlines)</code> in the R console (in the left bottom corner). Also, more generally, type <code>data()</code> in the console to see a list of all datasets that are loaded with libraries.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">left_join</span>(flight_stats_MSP, airlines, <span class="dt">by=</span><span class="st">&quot;carrier&quot;</span>) %&gt;%
<span class="st">  </span><span class="co"># left_join(a,b, by=&quot;var&quot;) means joining matching rows from b to a by identifier named &quot;var&quot;.  </span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)  <span class="co"># prints a better-looking table </span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">carrier</th>
<th align="right">n_obs</th>
<th align="right">mean_dep_delay</th>
<th align="right">mean_arr_delay</th>
<th align="left">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DL</td>
<td align="right">2864</td>
<td align="right">10.65</td>
<td align="right">4.04</td>
<td align="left">Delta Air Lines Inc.</td>
</tr>
<tr class="even">
<td align="left">EV</td>
<td align="right">1773</td>
<td align="right">17.09</td>
<td align="right">10.53</td>
<td align="left">ExpressJet Airlines Inc.</td>
</tr>
<tr class="odd">
<td align="left">MQ</td>
<td align="right">1293</td>
<td align="right">8.26</td>
<td align="right">9.56</td>
<td align="left">Envoy Air</td>
</tr>
<tr class="even">
<td align="left">9E</td>
<td align="right">1249</td>
<td align="right">19.66</td>
<td align="right">8.09</td>
<td align="left">Endeavor Air Inc.</td>
</tr>
<tr class="odd">
<td align="left">OO</td>
<td align="right">4</td>
<td align="right">0.75</td>
<td align="right">-2.00</td>
<td align="left">SkyWest Airlines Inc.</td>
</tr>
<tr class="even">
<td align="left">UA</td>
<td align="right">2</td>
<td align="right">-6.00</td>
<td align="right">-5.50</td>
<td align="left">United Air Lines Inc.</td>
</tr>
</tbody>
</table>
<p>Let’s consider an example of adding new variables using <code>mutate()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights %&gt;%
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay, air_time) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="co"># keep only columns named &quot;dep_delay&quot;, &quot;arr_delay&quot;, and &quot;air_time&quot; </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">gain =</span> arr_delay -<span class="st"> </span>dep_delay,
    <span class="dt">gain_per_hr =</span> gain /<span class="st"> </span>(air_time /<span class="st"> </span><span class="dv">60</span>)  
      <span class="co"># Note: we can refer to &quot;gain&quot; variable as we define. </span>
  )</code></pre></div>
<pre><code>## # A tibble: 336,776 × 5
##    dep_delay arr_delay air_time  gain gain_per_hr
##        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;
## 1          2        11      227     9    2.378855
## 2          4        20      227    16    4.229075
## 3          2        33      160    31   11.625000
## 4         -1       -18      183   -17   -5.573770
## 5         -6       -25      116   -19   -9.827586
## 6         -4        12      150    16    6.400000
## 7         -5        19      158    24    9.113924
## 8         -3       -14       53   -11  -12.452830
## 9         -3        -8      140    -5   -2.142857
## 10        -2         8      138    10    4.347826
## # ... with 336,766 more rows</code></pre>
<p>Note that by using <code>select()</code>, the data frame now contains only the selected columns “dep_delay”, “arr_delay”, and “air_time” and the new columns defined by <strong>window functions</strong> in <code>mutate()</code>. The five types of <a href="https://cran.r-project.org/web/packages/dplyr/vignettes/window-functions.html">window functions</a> are (1) recycled summary values which are interpreted as a vector of repeated values (any <strong>summary function</strong>): (2) of ranking or ordering type (<code>row_number()</code>, <code>min_rank()</code>, <code>dense_rank()</code>, <code>cume_dist()</code>,<code>percent_rank()</code>, and <code>ntile()</code>): (3) of offset type, say defining a lagged variable in time series data (<code>lead()</code> and <code>lag()</code>): (4) cumulative aggregates (<code>cumsum()</code>, <code>cummin()</code>, <code>cummax()</code>, <code>cumall()</code>, <code>cumany()</code>, and <code>cummean()</code>): (5) fixed-window rolling aggregates such as windowed mean, median, etc. (see <a href="https://cran.r-project.org/web/packages/RcppRoll/index.html">RcppRoll</a> package). You can find a help file for any function, for example, by typing <code>?cumsum</code>. Knowing what functions are available is useful.</p>
<p>We can also define custom functions and use them in <code>dplyr</code>-style data manipulations. A function takes some arguments and returns an output (Note: a list is used for returning multiple outputs). Arguments are separated by comma <code>&quot;,&quot;</code> and matched either by locations or equated object names with <code>&quot;=&quot;</code> sign. The user needs to enter all the arguments of a function except for those that have specified default values. Let’s go through a few examples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generate a sequence from 1 to 10 (by the increment of 1) and name it  &quot;vec1&quot;.  </span>
<span class="co"># adding &quot;()&quot;&quot; while making an assignment &quot;&lt;-&quot; means to print the new object. </span>
(vec1 &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">10</span>)  </code></pre></div>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(vec2 &lt;-<span class="st"> </span><span class="kw">c</span>(vec1, <span class="ot">NA</span>, <span class="ot">NA</span>)) </code></pre></div>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10 NA NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_mean_1 &lt;-<span class="st"> </span>function(x)  <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="co"># This function takes one argument: x and returns the calculation result of mean(x, na.rm = TRUE). </span>
  <span class="co"># x is required (and implicitly assumed to be a vector of numeric values). </span>
  <span class="co"># mean() is an existing function. The &quot;na.rm&quot; argument of mean() is set to be TRUE.  </span>
  <span class="co"># Note: this function is defined in one expression (R&#39;s execution). Multiple executions are combined with &quot;{ }&quot;. </span>

<span class="kw">my_mean_1</span>(vec1)</code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_mean_2 &lt;-<span class="st"> </span>function(x, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)  <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> na.rm)   
  <span class="co"># Input arguments: x and na.rm (optional with the default value of TRUE) </span>
  <span class="co"># Output: the calculation result of mean(x, na.rm = na.rm).</span>
  <span class="co"># The &quot;na.rm&quot; argument of mean() is provided as the &quot;na.rm&quot; argument of my_mean_2().</span>

<span class="kw">my_mean_2</span>(vec2)</code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_mean_2</span>(vec2, <span class="dt">na.rm=</span><span class="ot">FALSE</span>)  <span class="co"># not revmoving NA returns NA for the mean calculation.  </span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_zscore &lt;-<span class="st"> </span>function(x, <span class="dt">remove_na=</span><span class="ot">TRUE</span>) { 
  <span class="co"># blanketing with { } makes a long expression more legible. </span>
  (x -<span class="st"> </span><span class="kw">my_mean_2</span>(x, <span class="dt">na.rm =</span> remove_na))/<span class="kw">sd</span>(x, <span class="dt">na.rm =</span> remove_na)  
}
  <span class="co"># Inputs: x and remove_na (optional: default = TRUE)</span>
  <span class="co"># Output: z-score of vector x</span>
  <span class="co"># Note: this function uses a recycling rule of R. </span>
  <span class="co"># my_mean() and sd() are scalers but are interpreted as a vector of repeated valuses with the length of x. </span>

<span class="kw">my_zscore</span>(vec1) %&gt;%<span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</code></pre></div>
<pre><code>##  [1] -1.49 -1.16 -0.83 -0.50 -0.17  0.17  0.50  0.83  1.16  1.49</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_dow &lt;-<span class="st"> </span>function(date) {
  dow &lt;-<span class="st"> </span><span class="kw">as.POSIXlt</span>(date)[[<span class="st">&#39;wday&#39;</span>]] +<span class="st"> </span><span class="dv">1</span>
  <span class="co"># as.POSIXlt(date)[[&#39;wday&#39;]] returns integers 0, 1, 2, .. 6, for Sun, Mon, ... Sat.  </span>
  <span class="co"># Here we extract one item from a vector (Sun, Mon, ..., Sat) by position numbered between 1 to 7. </span>
  <span class="kw">c</span>(<span class="st">&quot;Sun&quot;</span>, <span class="st">&quot;Mon&quot;</span>, <span class="st">&quot;Tue&quot;</span>, <span class="st">&quot;Wed&quot;</span>, <span class="st">&quot;Thu&quot;</span>, <span class="st">&quot;Fri&quot;</span>, <span class="st">&quot;Sat&quot;</span>)[dow]  <span class="co"># extract &quot;dow&quot;-th element    </span>
} 
  <span class="co"># Input: date in the format of  &quot;2017-01-23&quot;</span>
  <span class="co"># Output: day of week </span>
<span class="kw">Sys.Date</span>()  <span class="co"># Sys.Date() returns the date </span></code></pre></div>
<pre><code>## [1] &quot;2017-03-29&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_dow</span>(<span class="kw">Sys.Date</span>()) </code></pre></div>
<pre><code>## [1] &quot;Wed&quot;</code></pre>
<p>Let’s apply these <code>my_mean_2()</code> and <code>my_zscore()</code> functions inside <code>summarise()</code> and <code>mutate()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dep_delay) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">mean_dep_delay =</span> <span class="kw">my_mean_2</span>(dep_delay),  <span class="co"># using my_mean_2()  </span>
    <span class="dt">mean_dep_delay_na =</span> <span class="kw">my_mean_2</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)  <span class="co"># this returns NA</span>
  ) %&gt;%
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">mean_dep_delay</th>
<th align="right">mean_dep_delay_na</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">12.64</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights_gain &lt;-<span class="st"> </span>flights %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay, air_time) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">gain =</span> arr_delay -<span class="st"> </span>dep_delay,
    <span class="dt">gain_per_hr =</span> gain /<span class="st"> </span>(air_time /<span class="st"> </span><span class="dv">60</span>), 
    <span class="dt">gain_z =</span> (gain -<span class="st"> </span><span class="kw">my_mean_2</span>(gain))/<span class="kw">sd</span>(gain, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),  <span class="co"># using my_mean_2()  </span>
    <span class="dt">gain_per_hr_z =</span> <span class="kw">my_zscore</span>(gain_per_hr)  <span class="co"># using my_zscore()   </span>
  )

<span class="kw">head</span>(flights_gain) %&gt;%
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">dep_delay</th>
<th align="right">arr_delay</th>
<th align="right">air_time</th>
<th align="right">gain</th>
<th align="right">gain_per_hr</th>
<th align="right">gain_z</th>
<th align="right">gain_per_hr_z</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="right">11</td>
<td align="right">227</td>
<td align="right">9</td>
<td align="right">2.38</td>
<td align="right">0.81</td>
<td align="right">0.50</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">20</td>
<td align="right">227</td>
<td align="right">16</td>
<td align="right">4.23</td>
<td align="right">1.20</td>
<td align="right">0.67</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">33</td>
<td align="right">160</td>
<td align="right">31</td>
<td align="right">11.62</td>
<td align="right">2.03</td>
<td align="right">1.33</td>
</tr>
<tr class="even">
<td align="right">-1</td>
<td align="right">-18</td>
<td align="right">183</td>
<td align="right">-17</td>
<td align="right">-5.57</td>
<td align="right">-0.63</td>
<td align="right">-0.21</td>
</tr>
<tr class="odd">
<td align="right">-6</td>
<td align="right">-25</td>
<td align="right">116</td>
<td align="right">-19</td>
<td align="right">-9.83</td>
<td align="right">-0.74</td>
<td align="right">-0.59</td>
</tr>
<tr class="even">
<td align="right">-4</td>
<td align="right">12</td>
<td align="right">150</td>
<td align="right">16</td>
<td align="right">6.40</td>
<td align="right">1.20</td>
<td align="right">0.86</td>
</tr>
</tbody>
</table>
<p>The <code>dplyr</code> package also contains <code>summarise_each()</code> function that can be used to apply standard <strong>summary functions</strong> to each column of variables. This is easy to use when there is only single argument, say <code>mean(vec1)</code>. Passing through multiple arguments, say <code>mean(vec2, na.rm=TRUE)</code>, involves some complication with syntax. Let’s first try removing rows that contain missing (NA) values and then apply <code>summarise_each()</code>. The concatenated function name indicates which function is used to generate the summary.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights_gain %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(-<span class="kw">contains</span>(<span class="st">&quot;_z&quot;</span>))  %&gt;%
<span class="st">    </span><span class="co"># deselect variables whose names contain &quot;_z&quot; using &quot;-&quot; sign in front. </span>
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay) &amp;<span class="st"> </span>!<span class="kw">is.na</span>(arr_delay)) %&gt;%<span class="st">  </span>
<span class="st">    </span><span class="co"># filter out rows that have NA values in dep_delay or arr_deplay</span>
<span class="st">  </span><span class="kw">summarise_each</span>(<span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;sd&quot;</span>)) %&gt;%<span class="st">  </span>
<span class="st">    </span><span class="co"># summarise_each(func_names) applies functions named func_names to each column. </span>
<span class="st">  </span><span class="kw">round</span>(<span class="dt">digits=</span><span class="dv">2</span>) </code></pre></div>
<pre><code>## # A tibble: 1 × 10
##   dep_delay_mean arr_delay_mean air_time_mean gain_mean gain_per_hr_mean
##            &lt;dbl&gt;          &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt;            &lt;dbl&gt;
## 1          12.56            6.9        150.69     -5.66            -3.26
## # ... with 5 more variables: dep_delay_sd &lt;dbl&gt;, arr_delay_sd &lt;dbl&gt;,
## #   air_time_sd &lt;dbl&gt;, gain_sd &lt;dbl&gt;, gain_per_hr_sd &lt;dbl&gt;</code></pre>
<p>The method for passing multiple arguments or using custom summary functions is to use a list generated by <code>funs()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_mean_fun &lt;-<span class="st"> </span><span class="kw">funs</span>(<span class="dt">m1 =</span> my_mean_2, <span class="dt">m2 =</span> <span class="st">&quot;my_mean_2&quot;</span>, <span class="dt">m3 =</span> <span class="kw">my_mean_2</span>(., <span class="dt">na.rm=</span><span class="ot">TRUE</span>))
  <span class="co"># funs() generates a list of functions calls that can be passed through summarise_each(): see ?funs</span>
  <span class="co"># m1: function object e.g. my_mean_2</span>
  <span class="co"># m2: function name  e.g. &quot;my_mean_2&quot; </span>
  <span class="co"># m3: function call with . parameter  e.g. my_mean_2(., na.rm=TRUE) </span>

flights_gain %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(-<span class="kw">contains</span>(<span class="st">&quot;_z&quot;</span>)) %&gt;%<span class="st">  </span>
<span class="st">  </span><span class="kw">summarise_each</span>(my_mean_fun) %&gt;%
<span class="st">    </span><span class="kw">round</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<pre><code>## # A tibble: 1 × 15
##   dep_delay_m1 arr_delay_m1 air_time_m1 gain_m1 gain_per_hr_m1
##          &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;
## 1        12.64          6.9      150.69   -5.66          -3.26
## # ... with 10 more variables: dep_delay_m2 &lt;dbl&gt;, arr_delay_m2 &lt;dbl&gt;,
## #   air_time_m2 &lt;dbl&gt;, gain_m2 &lt;dbl&gt;, gain_per_hr_m2 &lt;dbl&gt;,
## #   dep_delay_m3 &lt;dbl&gt;, arr_delay_m3 &lt;dbl&gt;, air_time_m3 &lt;dbl&gt;,
## #   gain_m3 &lt;dbl&gt;, gain_per_hr_m3 &lt;dbl&gt;</code></pre>
</div>
<div id="arts" class="section level3 unnumbered">
<h3>Arts</h3>
<p>Now let’s cover the basics of data visualization using <a href="http://docs.ggplot2.org/current/">ggplot2</a> package. There are three essential components to graphics in the <code>ggplot2</code> syntax: <strong>data</strong>, <strong>aes</strong>, and <strong>geom</strong> (<a href="https://ismayc.github.io/moderndiver-book/4-viz.html">ModernDive</a> open-source textbook). This implements a philosophy stated as follows;</p>
<blockquote>
<p>A statistical graphic is a mapping of <strong>data</strong> variables to <strong>aesthetic</strong> attributes of <strong>geometric</strong> objects.<br />
— <span class="citation">(Wilkinson <a href="#ref-Wilkinson2005">2005</a>)</span></p>
</blockquote>
<p>While coding complex graphics via <code>ggplot()</code> may appear intimidating at first, they boil down to the three primary components:</p>
<ul>
<li><p><strong>data</strong>: a data frame e.g. the first argument in <code>ggplot(data, ...)</code>.</p></li>
<li><p><strong>aes</strong>: specifications for x-y, color, shape, and size. e.g. <code>aes(x = var_x, y = var_y, shape = var_z)</code></p></li>
<li><p><strong>geom</strong>: geometric objects such as points, lines, bars, etc. e.g. <code>geom_point()</code>, <code>geom_line()</code>, <code>geom_histogram()</code></p></li>
</ul>
<p>Since R offers great flexibility with graphics, one can further combine secondary components such as:</p>
<ul>
<li><p>stat: data transformation, overlay of statistical inferences etc.</p></li>
<li><p>scales: scaling data points etc.</p></li>
<li><p>coord: Cartesian coordinates, polar coordinates, mapping projections etc.</p></li>
<li><p>facet: laying out multiple plot panels in a grid etc.</p></li>
</ul>
<p>and more. Following <a href="https://ismayc.github.io/moderndiver-book/4-viz.html">ModernDive</a>, let’s go over five basic types of plots: scatter-plots, line-graphs, boxplots, histograms, and barplots.</p>
<p>Let’s start with <strong>barplots</strong> by examining whether there is any obvious pattern of flight distribution across airport origins in New York. A barplot shows counts by category, a simple visualization.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> flights,  <span class="co"># the first argument is the data frame</span>
       <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> origin)) +<span class="st">   </span><span class="co"># the second argument is &quot;mapping&quot;, which is aes()   </span>
<span class="st">  </span><span class="kw">geom_bar</span>()  <span class="co">#  after &quot;+&quot; piping operator of ggplot(), we add geom_XXX() elements </span></code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>We can make this more informative and aesthetic.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> flights, 
       <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> origin, <span class="dt">fill =</span> origin)) +<span class="st">  </span><span class="co"># here &quot;fill&quot; gives bars distinct colors </span>
<span class="st">  </span><span class="kw">geom_bar</span>() +<span class="st">  </span>
<span class="st">  </span><span class="kw">facet_wrap</span>( ~<span class="st"> </span>hour)  <span class="co">#  &quot;facet_wrap( ~ var)&quot; generates a grid of plots for each value of var </span></code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>Another way to see the same information is a <strong>histogram</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(hour &gt;=<span class="st"> </span><span class="dv">5</span>) %&gt;%<span class="st">  </span><span class="co"># exclude hour earlier than 5 a.m.</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> hour, <span class="dt">fill =</span> origin )) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;white&quot;</span>) </code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>Mornings and late afternoons get busy, but there is not much difference across flight origins. Is there a pattern throughout the year? Let’s take the average of departure delays for each day by flight origin and plot as a time series.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day &lt;-<span class="st"> </span>flights %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(origin, year, month, day) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))  %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(<span class="kw">paste</span>(year, month, day), <span class="dt">format=</span><span class="st">&quot;%Y %m %d&quot;</span>)) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay))  <span class="co">#  exclude rows with dep_delay == NA </span>

delay_day %&gt;%<span class="st">     </span><span class="co"># &quot;facet_grid( var ~ .)&quot; is similar to &quot;facet_wrap( ~ var)&quot; </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> dep_delay)) +<span class="st"> </span><span class="kw">geom_line</span>() +<span class="st"> </span><span class="kw">facet_grid</span>( origin ~<span class="st"> </span>. ) </code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>Are the three series correlated? Let’s look at a few months more closely.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="st">&quot;2013-07-01&quot;</span> &lt;=<span class="st"> </span>date, <span class="st">&quot;2013-08-31&quot;</span> &gt;=<span class="st"> </span>date)  %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> dep_delay, <span class="dt">color =</span> origin)) +<span class="st"> </span><span class="kw">geom_line</span>()  </code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>We see similar patterns of speakes and troughs occuring on certain days. Is the pattern cyclical? Let’s compare by day of the week.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day &lt;-<span class="st"> </span>flights %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(year, month, day) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))  %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(<span class="kw">paste</span>(year, month, day), <span class="dt">format=</span><span class="st">&quot;%Y %m %d&quot;</span>),  <span class="co"># date defined by as.Data() function </span>
         <span class="dt">wday =</span> <span class="kw">my_dow</span>(date),
         <span class="dt">weekend =</span> wday %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Sat&quot;</span>, <span class="st">&quot;Sun&quot;</span>)  <span class="co">#  %in% operator: A %in% B checks whether each element of A is in B. </span>
  )

delay_day$wday[<span class="dv">1</span>:<span class="dv">20</span>] %&gt;%<span class="st"> </span><span class="kw">print</span>()</code></pre></div>
<pre><code>##  [1] &quot;Tue&quot; &quot;Wed&quot; &quot;Thu&quot; &quot;Fri&quot; &quot;Sat&quot; &quot;Sun&quot; &quot;Mon&quot; &quot;Tue&quot; &quot;Wed&quot; &quot;Thu&quot; &quot;Fri&quot;
## [12] &quot;Sat&quot; &quot;Sun&quot; &quot;Mon&quot; &quot;Tue&quot; &quot;Wed&quot; &quot;Thu&quot; &quot;Fri&quot; &quot;Sat&quot; &quot;Sun&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day$wday &lt;-<span class="st"> </span><span class="kw">factor</span>(delay_day$wday, 
                         <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Mon&quot;</span>, <span class="st">&quot;Tue&quot;</span>, <span class="st">&quot;Wed&quot;</span>, <span class="st">&quot;Thu&quot;</span>, <span class="st">&quot;Fri&quot;</span>, <span class="st">&quot;Sat&quot;</span>, <span class="st">&quot;Sun&quot;</span>))
                            <span class="co"># adding labels and rearranging the order starting on Mon</span>
delay_day$wday[<span class="dv">1</span>:<span class="dv">20</span>] %&gt;%<span class="st"> </span><span class="kw">print</span>() </code></pre></div>
<pre><code>##  [1] Tue Wed Thu Fri Sat Sun Mon Tue Wed Thu Fri Sat Sun Mon Tue Wed Thu
## [18] Fri Sat Sun
## Levels: Mon Tue Wed Thu Fri Sat Sun</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day  %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay)) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> wday, <span class="dt">y =</span> dep_delay, <span class="dt">fill =</span> weekend)) +<span class="st"> </span><span class="kw">geom_boxplot</span>() </code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>It appears that average delays are longer on Thursdays and Fridays and shorter on Saturdays.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day_hr &lt;-<span class="st"> </span>flights %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(year, month, day, hour) %&gt;%<span class="st">  </span><span class="co"># Note: &quot;hour&quot; is added here  </span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">n_obs =</span> <span class="kw">n</span>(),
    <span class="dt">dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
    <span class="dt">arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
    <span class="co"># gain = mean(arr_delay - dep_delay, na.rm = TRUE),</span>
    <span class="co"># dist = mean(distance, na.rm = TRUE)</span>
  )  %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(<span class="kw">paste</span>(year, month, day), <span class="dt">format=</span><span class="st">&quot;%Y %m %d&quot;</span>),
         <span class="dt">wday =</span> <span class="kw">c</span>(<span class="st">&quot;Sun&quot;</span>, <span class="st">&quot;Mon&quot;</span>, <span class="st">&quot;Tue&quot;</span>, <span class="st">&quot;Wed&quot;</span>, <span class="st">&quot;Thu&quot;</span>, <span class="st">&quot;Fri&quot;</span>, <span class="st">&quot;Sat&quot;</span>)[<span class="kw">as.POSIXlt</span>(date)[[<span class="st">&#39;wday&#39;</span>]] +<span class="st"> </span><span class="dv">1</span>]
  )

plot_delay &lt;-<span class="st"> </span>delay_day_hr  %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n_obs, <span class="dt">y =</span> dep_delay)) +<span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.1</span>)  
    <span class="co"># plot of n_obs and the average dep_delay by date-hour </span>

plot_delay </code></pre></div>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>The plot shows that by the density of data points along the horizontal axis, the number of flights is not evenly distributed across all date-hours. That is, some days are businer than others, and some hours are busiers than others. The distribution of <code>n_obs</code> has two peaks, showing that there are very slow days or hours at the airports (e.g. less than 10 flights flying out of New York city in hour). We might guess that the delays in the slow days or hours be caused by bad weather in New York (or in other cities to an extent). On the other hand, we may wonder if the excess delays in peak hours, compared to slow hours, are caused by congestion at the airports. Let’s find out by fitting curves that trace out the relationships between <code>n_obs</code> and <code>dep_delay</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plot_delay  +
<span class="st">  </span><span class="kw">geom_smooth</span>()   <span class="co">#  geom_smooth() addes a layer of fitted curve(s) </span></code></pre></div>
<pre><code>## `geom_smooth()` using method = &#39;gam&#39;</code></pre>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plot_delay  +
<span class="st">     </span><span class="co"># additional aes() argument for applying different colors to the day of the week</span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">color =</span> wday), <span class="dt">se=</span><span class="ot">FALSE</span>) </code></pre></div>
<pre><code>## `geom_smooth()` using method = &#39;gam&#39;</code></pre>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-20-2.png" width="672" /></p>
<p>Surprisingly, <code>dep_delay</code> do not change over the range of <code>n_obs</code>, including the peak hours. There are more dealys on Thursdays and Fridays and less delays on Saturdays, but we see no evidence of congestion as a cause of delay.</p>
<p>Let’s take a closer look at the distribution of departure delays. If it is not normal, we may want to apply a transformation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day_hr %&gt;%<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dep_delay)) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>) <span class="co"># Note: the distribution is skewed  </span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day_hr$dep_delay_shifted &lt;-<span class="st"> </span>delay_day_hr %&gt;%<span class="st"> </span><span class="kw">with</span>(dep_delay -<span class="st"> </span><span class="kw">min</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) +<span class="st"> </span><span class="dv">1</span>) 
    <span class="co"># with() function: it takes a data frame in the first argument and allows one to use variable names inside the data frame</span>
    <span class="co"># Before we apply a logarithmic transformation, we shift the variable so that its minimum is greater than zero. </span>

delay_day_hr %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%<span class="st">   </span><span class="co"># removing group_by() attribute</span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, dep_delay_shifted) %&gt;%
<span class="st">  </span><span class="kw">with</span>(
    <span class="kw">apply</span>(., <span class="dv">2</span>, summary)
    <span class="co"># apply(data, num, fun)  applies function &quot;fun&quot; for each item of dimention &quot;num&quot; (1 = cows, 2= columns) of the data frame    </span>
    <span class="co"># In apply(), data comes from with() function and contains two selected variables. </span>
    <span class="co"># These variables are referened by &quot;.&quot; (all variables) </span>
    )  </code></pre></div>
<pre><code>##         dep_delay dep_delay_shifted
## Min.      -18.000              1.00
## 1st Qu.     1.054             20.05
## Median      6.571             25.57
## Mean       12.990             31.99
## 3rd Qu.    15.440             34.44
## Max.      269.000            288.00
## NA&#39;s       13.000             13.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day_hr %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay_shifted), dep_delay_shifted &gt;<span class="st"> </span><span class="dv">5</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dep_delay_shifted))  +<span class="st">  </span>
<span class="st">  </span><span class="kw">scale_x_log10</span>() +<span class="st"> </span>
<span class="st">    </span><span class="co"># Under the log of 10 transformation, the distribution looks closer to a normal distribution.</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>) </code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-21-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day_hr %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay_shifted), dep_delay_shifted &gt;<span class="st"> </span><span class="dv">5</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> dep_delay_shifted)) +<span class="st">  </span>
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">trans =</span> <span class="st">&quot;log&quot;</span>) +<span class="st">  </span>
<span class="st">    </span><span class="co"># Alternatively, one can apply the natural logarithm to transform a variable. Histogram shows no difference here.    </span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-21-3.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_day_hr  %&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(dep_delay_shifted), dep_delay_shifted &gt;<span class="st"> </span><span class="dv">5</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n_obs, <span class="dt">y =</span> dep_delay_shifted)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_log10</span>() +<span class="st"> </span>
<span class="st">   </span><span class="co"># With the transformation scale_y_log10(),  geom_point() and geom_smooth() are plotted. </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.1</span>)  +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_smooth</span>()  </code></pre></div>
<pre><code>## `geom_smooth()` using method = &#39;gam&#39;</code></pre>
<p><img src="01-Introduction_files/figure-html/unnamed-chunk-21-4.png" width="672" /></p>
<p>Under the logarithmic transformation, we still see no evidence that busy hours have more delays than slow hours. This appears to suggest that the airports in New York City manage fluctuating numbers of flights very well without causing congestion.</p>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Wilkinson2005">
<p>Wilkinson, Leland. 2005. <em>The Grammar of Graphics</em>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="materials.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="huning-down-numbers.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/kotamine/piecemealR/edit/master/01-Introduction.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
