<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Piecemeal R</title>
  <meta name="description" content="This is a R tutorial.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Piecemeal R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a R tutorial." />
  <meta name="github-repo" content="/kotamine/piecemealR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Piecemeal R" />
  
  <meta name="twitter:description" content="This is a R tutorial." />
  




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="2-1-materials.html">
<link rel="next" href="2-3-arts.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.2/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.4/datatables.js"></script>
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.16/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-97062240-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Piecemeal R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome</a><ul>
<li class="chapter" data-level="" data-path="about.html"><a href="about.html"><i class="fa fa-check"></i>About</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="2-intro.html"><a href="2-intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="2-1-materials.html"><a href="2-1-materials.html"><i class="fa fa-check"></i><b>2.1</b> Materials</a></li>
<li class="chapter" data-level="2.2" data-path="2-2-crafts.html"><a href="2-2-crafts.html"><i class="fa fa-check"></i><b>2.2</b> Crafts</a></li>
<li class="chapter" data-level="2.3" data-path="2-3-arts.html"><a href="2-3-arts.html"><i class="fa fa-check"></i><b>2.3</b> Arts</a></li>
<li class="chapter" data-level="2.4" data-path="2-4-more-examples-1.html"><a href="2-4-more-examples-1.html"><i class="fa fa-check"></i><b>2.4</b> More examples 1</a></li>
<li class="chapter" data-level="2.5" data-path="2-5-more-examples-2.html"><a href="2-5-more-examples-2.html"><i class="fa fa-check"></i><b>2.5</b> More examples 2</a></li>
<li class="chapter" data-level="2.6" data-path="2-6-reflections.html"><a href="2-6-reflections.html"><i class="fa fa-check"></i><b>2.6</b> Reflections</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="3-essentials.html"><a href="3-essentials.html"><i class="fa fa-check"></i><b>3</b> Essentials</a><ul>
<li class="chapter" data-level="3.1" data-path="3-1-cheatsheets.html"><a href="3-1-cheatsheets.html"><i class="fa fa-check"></i><b>3.1</b> Cheatsheets</a></li>
<li class="chapter" data-level="3.2" data-path="3-2-datatypes.html"><a href="3-2-datatypes.html"><i class="fa fa-check"></i><b>3.2</b> Data types</a><ul>
<li class="chapter" data-level="3.2.1" data-path="3-2-datatypes.html"><a href="3-2-datatypes.html#atomic"><i class="fa fa-check"></i><b>3.2.1</b> Atomic</a></li>
<li class="chapter" data-level="3.2.2" data-path="3-2-datatypes.html"><a href="3-2-datatypes.html#factor"><i class="fa fa-check"></i><b>3.2.2</b> Factor</a></li>
<li class="chapter" data-level="3.2.3" data-path="3-2-datatypes.html"><a href="3-2-datatypes.html#matrix"><i class="fa fa-check"></i><b>3.2.3</b> Matrix</a></li>
<li class="chapter" data-level="3.2.4" data-path="3-2-datatypes.html"><a href="3-2-datatypes.html#data-frame"><i class="fa fa-check"></i><b>3.2.4</b> Data Frame</a></li>
<li class="chapter" data-level="3.2.5" data-path="3-2-datatypes.html"><a href="3-2-datatypes.html#list"><i class="fa fa-check"></i><b>3.2.5</b> List</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="3-3-programming.html"><a href="3-3-programming.html"><i class="fa fa-check"></i><b>3.3</b> Programming</a><ul>
<li class="chapter" data-level="3.3.1" data-path="3-3-programming.html"><a href="3-3-programming.html#operator"><i class="fa fa-check"></i><b>3.3.1</b> Operator</a></li>
<li class="chapter" data-level="3.3.2" data-path="3-3-programming.html"><a href="3-3-programming.html#if-else"><i class="fa fa-check"></i><b>3.3.2</b> If else</a></li>
<li class="chapter" data-level="3.3.3" data-path="3-3-programming.html"><a href="3-3-programming.html#loop"><i class="fa fa-check"></i><b>3.3.3</b> Loop</a></li>
<li class="chapter" data-level="3.3.4" data-path="3-3-programming.html"><a href="3-3-programming.html#function"><i class="fa fa-check"></i><b>3.3.4</b> Function</a></li>
<li class="chapter" data-level="3.3.5" data-path="3-3-programming.html"><a href="3-3-programming.html#environment"><i class="fa fa-check"></i><b>3.3.5</b> Environment</a></li>
<li class="chapter" data-level="3.3.6" data-path="3-3-programming.html"><a href="3-3-programming.html#debugging"><i class="fa fa-check"></i><b>3.3.6</b> Debugging</a></li>
<li class="chapter" data-level="3.3.7" data-path="3-3-programming.html"><a href="3-3-programming.html#stat-func."><i class="fa fa-check"></i><b>3.3.7</b> Stat func.</a></li>
<li class="chapter" data-level="3.3.8" data-path="3-3-programming.html"><a href="3-3-programming.html#string-func."><i class="fa fa-check"></i><b>3.3.8</b> String func.</a></li>
<li class="chapter" data-level="3.3.9" data-path="3-3-programming.html"><a href="3-3-programming.html#set-func."><i class="fa fa-check"></i><b>3.3.9</b> Set func.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="3-4-housekeeping.html"><a href="3-4-housekeeping.html"><i class="fa fa-check"></i><b>3.4</b> Housekeeping</a><ul>
<li class="chapter" data-level="3.4.1" data-path="3-4-housekeeping.html"><a href="3-4-housekeeping.html#working-directory"><i class="fa fa-check"></i><b>3.4.1</b> Working directory</a></li>
<li class="chapter" data-level="3.4.2" data-path="3-4-housekeeping.html"><a href="3-4-housekeeping.html#r-session"><i class="fa fa-check"></i><b>3.4.2</b> R session</a></li>
<li class="chapter" data-level="3.4.3" data-path="3-4-housekeeping.html"><a href="3-4-housekeeping.html#save-load"><i class="fa fa-check"></i><b>3.4.3</b> Save &amp; load</a></li>
<li class="chapter" data-level="3.4.4" data-path="3-4-housekeeping.html"><a href="3-4-housekeeping.html#input-output"><i class="fa fa-check"></i><b>3.4.4</b> Input &amp; Output</a></li>
<li class="chapter" data-level="3.4.5" data-path="3-4-housekeeping.html"><a href="3-4-housekeeping.html#updating"><i class="fa fa-check"></i><b>3.4.5</b> Updating</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="4-piecemeal-top.html"><a href="4-piecemeal-top.html"><i class="fa fa-check"></i><b>4</b> Piecemeal Topics</a><ul>
<li class="chapter" data-level="4.1" data-path="4-1-dplyr.html"><a href="4-1-dplyr.html"><i class="fa fa-check"></i><b>4.1</b> Unusual Deaths in Mexico</a><ul>
<li class="chapter" data-level="" data-path="4-1-dplyr.html"><a href="4-1-dplyr.html#materials-1"><i class="fa fa-check"></i>Materials</a></li>
<li class="chapter" data-level="" data-path="4-1-dplyr.html"><a href="4-1-dplyr.html#arts-crafts"><i class="fa fa-check"></i>Arts &amp; Crafts</a></li>
<li class="chapter" data-level="" data-path="4-1-dplyr.html"><a href="4-1-dplyr.html#exercise"><i class="fa fa-check"></i>Exercise</a></li>
<li class="chapter" data-level="" data-path="4-1-dplyr.html"><a href="4-1-dplyr.html#the-key"><i class="fa fa-check"></i>The Key</a></li>
<li class="chapter" data-level="" data-path="4-1-dplyr.html"><a href="4-1-dplyr.html#reflections-1"><i class="fa fa-check"></i>Reflections</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="4-2-boot.html"><a href="4-2-boot.html"><i class="fa fa-check"></i><b>4.2</b> Action, Romance, and Chicks</a><ul>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#materials-2"><i class="fa fa-check"></i>Materials</a></li>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#t-test"><i class="fa fa-check"></i>t-test</a></li>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#bootstrapping"><i class="fa fa-check"></i>Bootstrapping</a></li>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#linear-models"><i class="fa fa-check"></i>Linear Models</a></li>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#exercise-1"><i class="fa fa-check"></i>Exercise</a></li>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#the-key-1"><i class="fa fa-check"></i>The Key</a></li>
<li class="chapter" data-level="" data-path="4-2-boot.html"><a href="4-2-boot.html#reflections-2"><i class="fa fa-check"></i>Reflections</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="5-resources.html"><a href="5-resources.html"><i class="fa fa-check"></i><b>5</b> Resources</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/yihui/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Piecemeal R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="crafts" class="section level2">
<h2><span class="header-section-number">2.2</span> Crafts</h2>
<p>We will focus on six data wrangling functions in the <code>dplyr</code> package:</p>
<ul>
<li><p><code>filter()</code>: extracts rows (observations) of a data frame based on logical vectors.</p></li>
<li><p><code>select()</code>: extracts columns (variables) of a data frame based on column names.</p></li>
<li><p><code>arrange()</code>: orders rows of a data frame based on column names.</p></li>
<li><p><code>summarise()</code>: collapses a data frame into summary statistics based on <strong>summary functions</strong> (e.g., statistics functions) specified with column names.</p></li>
<li><p><code>mutate()</code>: creates new variables and adds them to the existing columns based on <strong>window functions</strong> (e.g., transforming operations) specified with column names.</p></li>
<li><p><code>group_by()</code>: assigns rows into groups within a data frame based on column names.</p></li>
</ul>
<p>The very first argument in all these functions is a <strong>data frame</strong>, followed by logical vectors, column names, or other kinds of items. This allows for applying these functions sequentially through the first argument; for example, <code>func3(func2(func1(data,...), ...), ...)</code>. This can be rewritten as <code>data %&gt;% func1(...) %&gt;% func2(...) %&gt;% func3(...)</code> via <strong>a pipe operator</strong> <code>%&gt;%</code>.<br />
This lets us express a sequence of data wrangling operations in plain English. Specifically, we read <code>%&gt;%</code> as <strong>then</strong>, so that the above example becomes; start with the data, then apply <code>func1(...)</code>, then apply <code>func2(...)</code>, then <code>func3(..)</code>.</p>
<p>Say, we want to find the average of delays in departures and arrivals from New York to the St. Paul-Minneapolis airport (MSP). We can construct the following sequence of instructions: start with the flight data frame, apply <code>filter()</code> to extract the rows of flights to MSP, and then apply <code>summarise()</code> to calculate the mean.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># data frame &quot;flights&quot;, then</span>
<span class="st">  </span><span class="kw">filter</span>(dest <span class="op">==</span><span class="st"> &quot;MSP&quot;</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># filter rows, then  </span>
<span class="st">  </span><span class="kw">summarise</span>(   
    <span class="co"># summarise departure and arrival delays for their means </span>
    <span class="co"># and call them mean_dep_delay and mean_arr_delay respectively</span>
    <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), 
    <span class="dt">mean_arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) 
    )    <span class="co"># calculate the mean, while removing NA values  </span></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   mean_dep_delay mean_arr_delay
##            &lt;dbl&gt;          &lt;dbl&gt;
## 1           13.3           7.27</code></pre>
<p>In <code>summarise()</code>, one can use <strong>summary functions</strong> that maps a vector to a scaler. Examples include functions like <code>mean()</code>, <code>sd()</code> (standard deviation), <code>quantile()</code>, <code>min()</code>, <code>max()</code>, and <code>n()</code> (observation count in the <code>dplyr</code> package).</p>
<p>Each time we apply the <code>%&gt;%</code> operator above, we pass a modified data frame from one data wrangling operation to another through the first argument. The above code is equivalent to</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(   <span class="co"># data frame &quot;flights&quot; is inside filter(), which is inside summarise() </span>
    <span class="kw">filter</span>(flights, dest <span class="op">==</span><span class="st"> &quot;MSP&quot;</span>), 
    <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
    <span class="dt">mean_arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
    )</code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   mean_dep_delay mean_arr_delay
##            &lt;dbl&gt;          &lt;dbl&gt;
## 1           13.3           7.27</code></pre>
<p>You will quickly discover that <code>%&gt;%</code> operator makes the code much easier to read, write, and edit and how that inspires you to explore the data more.</p>
<p>Let’s add a few more lines to the previous example. Say, now we want to see the average delay by carrier and sort the results by the number of observations (e.g. flights) in descending order.</p>
<p>Okay, what do we do? We make <strong>a sequence of data wrangling operations in plain English</strong> and translate that into <strong>code</strong> by replacing <strong>then</strong> with pipe operator <code>%&gt;%</code>.<br />
For example, try thinking this way; “start with the data frame <code>flights</code>; <strong>then</strong> (<code>%&gt;%</code>) <code>filter()</code> to extract the rows of flights to MSP; <strong>then</strong> group rows by carrier; <strong>then</strong> <code>summarise()</code> data for the number of observations and the means; <strong>then</strong> <code>arrange()</code> the results by the observation count in descending order.”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flight_stats_MSP &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># assign the results to an object named &quot;flight_stats&quot;</span>
<span class="st">  </span><span class="kw">filter</span>(dest <span class="op">==</span><span class="st"> &quot;MSP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(carrier) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">#  group rows by carrier </span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">n_obs =</span> <span class="kw">n</span>(),  <span class="co"># count number of rows </span>
    <span class="dt">mean_dep_delay =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
    <span class="dt">mean_arr_delay =</span> <span class="kw">mean</span>(arr_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n_obs))  <span class="co"># sort by n_obs in descending order</span>

flight_stats_MSP  <span class="co"># show flight_stats object</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   carrier n_obs mean_dep_delay mean_arr_delay
##   &lt;chr&gt;   &lt;int&gt;          &lt;dbl&gt;          &lt;dbl&gt;
## 1 DL       2864         10.7             4.04
## 2 EV       1773         17.1            10.5 
## 3 MQ       1293          8.26            9.56
## 4 9E       1249         19.7             8.09
## 5 OO          4          0.750          -2.00
## 6 UA          2         -6.00           -5.50</code></pre>
<p><strong>Tip #1: Frame tasks in a sequence and use pipe operator %&gt;% accordingly.</strong></p>
<p>The carrier variable is expressed in the International Air Transportation Association (IATA) code, so let’s add a column of carrier names by joining another data frame called <code>airlines</code>. In RStudio, you can find this data frame under the <strong>Environment</strong> tab (in the upper right corner); switch the display option from <em>Global Environment</em> to <em>package:nycflights13</em>. To inspect the data frame, type <code>View(airlines)</code> in the R console. Also, by typing <code>data()</code> you can see a list of all datasets that are loaded with libraries.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># left_join(a,b, by=&quot;var&quot;) joins two data frames a and b by matching rows of b to a </span>
  <span class="co"># by identifier variable &quot;var&quot;.</span>
<span class="co"># kable() prints a better-looking table here</span>
<span class="kw">left_join</span>(flight_stats_MSP, airlines, <span class="dt">by=</span><span class="st">&quot;carrier&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>) </code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">carrier</th>
<th align="right">n_obs</th>
<th align="right">mean_dep_delay</th>
<th align="right">mean_arr_delay</th>
<th align="left">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DL</td>
<td align="right">2864</td>
<td align="right">10.65</td>
<td align="right">4.04</td>
<td align="left">Delta Air Lines Inc.</td>
</tr>
<tr class="even">
<td align="left">EV</td>
<td align="right">1773</td>
<td align="right">17.09</td>
<td align="right">10.53</td>
<td align="left">ExpressJet Airlines Inc.</td>
</tr>
<tr class="odd">
<td align="left">MQ</td>
<td align="right">1293</td>
<td align="right">8.26</td>
<td align="right">9.56</td>
<td align="left">Envoy Air</td>
</tr>
<tr class="even">
<td align="left">9E</td>
<td align="right">1249</td>
<td align="right">19.66</td>
<td align="right">8.09</td>
<td align="left">Endeavor Air Inc.</td>
</tr>
<tr class="odd">
<td align="left">OO</td>
<td align="right">4</td>
<td align="right">0.75</td>
<td align="right">-2.00</td>
<td align="left">SkyWest Airlines Inc.</td>
</tr>
<tr class="even">
<td align="left">UA</td>
<td align="right">2</td>
<td align="right">-6.00</td>
<td align="right">-5.50</td>
<td align="left">United Air Lines Inc.</td>
</tr>
</tbody>
</table>
<p>In the next example, we add new variables to <code>flights</code> using <code>mutate()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># keep only columns named &quot;dep_delay&quot; and &quot;arr_delay&quot;</span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">gain =</span> arr_delay <span class="op">-</span><span class="st"> </span>dep_delay,
    <span class="dt">gain_rank =</span> <span class="kw">round</span>(<span class="kw">percent_rank</span>(gain), <span class="dt">digits =</span> <span class="dv">2</span>)
      <span class="co"># Note: we can immediately use the &quot;gain&quot; variable we just defined. </span>
  )</code></pre></div>
<pre><code>## # A tibble: 336,776 x 4
##    dep_delay arr_delay  gain gain_rank
##        &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1        2.       11.    9.     0.810
##  2        4.       20.   16.     0.880
##  3        2.       33.   31.     0.940
##  4       -1.      -18.  -17.     0.220
##  5       -6.      -25.  -19.     0.180
##  6       -4.       12.   16.     0.880
##  7       -5.       19.   24.     0.920
##  8       -3.      -14.  -11.     0.370
##  9       -3.       -8.   -5.     0.540
## 10       -2.        8.   10.     0.820
## # ... with 336,766 more rows</code></pre>
<p>We extracted specific columns of <code>flights</code> by <code>select()</code> and added new columns defined in <code>mutate()</code>. <code>mutate()</code> differs from <code>summarise()</code> in that <code>mutate()</code> adds new columns to the data frame, while <code>summarise()</code> collapses the data frame into a summary table.</p>
<p>There are roughly five types of <a href="https://cran.r-project.org/web/packages/dplyr/vignettes/window-functions.html">window functions</a> that are commonly used inside <code>mutate()</code>:</p>
<ul>
<li><ol style="list-style-type: decimal">
<li><strong>summary functions</strong>, which are interpreted as a vector of repeated values (e.g., a column of an identical mean value)</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>ranking or ordering functions (e.g., <code>row_number()</code>, <code>min_rank()</code>, <code>dense_rank()</code>, <code>cume_dist()</code>, <code>percent_rank()</code>, and <code>ntile()</code>)</li>
</ol></li>
<li><ol start="3" style="list-style-type: decimal">
<li>offset functions, say defining a lagged variable in time series data (<code>lead()</code> and <code>lag()</code>)</li>
</ol></li>
<li><ol start="4" style="list-style-type: decimal">
<li>cumulative aggregates (e.g., <code>cumsum()</code>, <code>cummin()</code>, <code>cummax()</code>, <code>cumall()</code>, <code>cumany()</code>, and <code>cummean()</code>)</li>
</ol></li>
<li><ol start="5" style="list-style-type: decimal">
<li>fixed-window rolling aggregates such as a windowed mean, median, etc.<br />
To look up documentations of these function, for example, type <code>?cumsum</code>.</li>
</ol></li>
</ul>
<p><strong>Tip #2: In the beginning you might find it confusing to choose between <code>summarise()</code> and <code>mutate()</code>. Just remeber <code>mutate()</code> is for creating new variables or overwriting existing variables.</strong></p>
<p>By no means, the use of <code>summarise()</code> and <code>mutate()</code> is not restricted to these functions listed above. You can define your own function and apply inside <code>summarise()</code> or <code>mutate()</code>. Let’s quickly go over what a <strong>function</strong> is in R and how you can use a custom function in the <em>tidyverse syntax</em>.</p>
<p>In R, we use <code>function()</code> to define a function, which consists of a function name, input arguments separated by comma, and a body containing tasks to be performed (multiple expressions are bundled by brackets <code>{ }</code>, and the last expression is returned as an output).</p>
<pre><code>your_function_name &lt;- function(input_arg1, input_arg2) {
                        task1
                        task2
                        .
                        .
                        .
                        output_to_return 
                      } </code></pre>
<p>For a function having only a single expression to execute, we can omit brackets <code>{ }</code>.</p>
<pre><code>another_function &lt;- function(input args) task_and_output_in_a_single_expression                    </code></pre>
<p>Let’s go through a few examples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vec1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)
vec1</code></pre></div>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10 NA NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_mean &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)  <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> na.rm)   
<span class="co"># sets the default of &quot;na.rm&quot; argument to be TRUE. </span>

<span class="kw">mean</span>(vec1) <span class="co"># returns NA</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_mean</span>(vec1)</code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_mean</span>(vec1, <span class="dt">na.rm=</span><span class="ot">FALSE</span>)  <span class="co"># returns NA</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_zscore &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">remove_na=</span><span class="ot">TRUE</span>, <span class="dt">digits=</span><span class="dv">2</span>) { 
  zscore &lt;-<span class="st"> </span>(x <span class="op">-</span><span class="st"> </span><span class="kw">my_mean</span>(x, <span class="dt">na.rm =</span> remove_na))<span class="op">/</span><span class="kw">sd</span>(x, <span class="dt">na.rm =</span> remove_na)  
  <span class="kw">round</span>(zscore, <span class="dt">digits=</span>digits)
}
  <span class="co"># calculates a z-score of vector x</span>

<span class="kw">my_zscore</span>(vec1)</code></pre></div>
<pre><code>##  [1] -1.49 -1.16 -0.83 -0.50 -0.17  0.17  0.50  0.83  1.16  1.49    NA
## [12]    NA</code></pre>
<p>Let’s try using functions <code>my_mean()</code> and <code>my_zscore()</code> in <code>summarise()</code> and <code>mutate()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dep_delay) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(
    <span class="dt">mean_dep_delay_na =</span> <span class="kw">mean</span>(dep_delay),  <span class="co"># returns NA</span>
    <span class="dt">mean_dep_delay_1 =</span> <span class="kw">mean</span>(dep_delay, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="co"># passing argument na.rm = TRUE</span>
    <span class="dt">mean_dep_delay_2 =</span> <span class="kw">my_mean</span>(dep_delay)  <span class="co"># using my_mean()  </span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">mean_dep_delay_na</th>
<th align="right">mean_dep_delay_1</th>
<th align="right">mean_dep_delay_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">NA</td>
<td align="right">12.64</td>
<td align="right">12.64</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flights_gain &lt;-<span class="st"> </span>flights <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">gain =</span> arr_delay <span class="op">-</span><span class="st"> </span>dep_delay,
    <span class="dt">gain_mean =</span> <span class="kw">my_mean</span>(gain),  <span class="co"># returns the same mean for all rows</span>
    <span class="dt">gain_z2 =</span> <span class="kw">my_zscore</span>(gain)  <span class="co"># using my_zscore()   </span>
  )

<span class="kw">head</span>(flights_gain) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># show the first several rows</span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">dep_delay</th>
<th align="right">arr_delay</th>
<th align="right">gain</th>
<th align="right">gain_mean</th>
<th align="right">gain_z2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="right">11</td>
<td align="right">9</td>
<td align="right">-5.66</td>
<td align="right">0.81</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">20</td>
<td align="right">16</td>
<td align="right">-5.66</td>
<td align="right">1.20</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">33</td>
<td align="right">31</td>
<td align="right">-5.66</td>
<td align="right">2.03</td>
</tr>
<tr class="even">
<td align="right">-1</td>
<td align="right">-18</td>
<td align="right">-17</td>
<td align="right">-5.66</td>
<td align="right">-0.63</td>
</tr>
<tr class="odd">
<td align="right">-6</td>
<td align="right">-25</td>
<td align="right">-19</td>
<td align="right">-5.66</td>
<td align="right">-0.74</td>
</tr>
<tr class="even">
<td align="right">-4</td>
<td align="right">12</td>
<td align="right">16</td>
<td align="right">-5.66</td>
<td align="right">1.20</td>
</tr>
</tbody>
</table>
<!-- Creating a function reduces repetitious codes in multiple places, which makes editing easier and also helps reduce coding errors.  -->
<p><code>summarise_all()</code> and <code>mutate_all()</code> apply <strong>summary functions</strong> like <code>mean()</code> and <code>sd()</code> to all columns in a data frame. But, we can also use any custom function that returns appropriate output (i.e., a scalar output for <code>summarise_all()</code> and a vector output for <code>mutate_all()</code>). For example, here are several ways to calculate the means when the data frame contains missing values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculation fails due to NA values </span>
flights_gain <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay, gain)  <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(mean) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>) </code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">dep_delay</th>
<th align="right">arr_delay</th>
<th align="right">gain</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># filter rows that contain any NA value </span>
flights_gain <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay, gain)  <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(dep_delay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(arr_delay)) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">summarise_all</span>(mean) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>) </code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">dep_delay</th>
<th align="right">arr_delay</th>
<th align="right">gain</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">12.56</td>
<td align="right">6.9</td>
<td align="right">-5.66</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># pass argument na.rm=TRUE to mean()</span>
flights_gain <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay, gain) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">funs</span>(mean), <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">dep_delay</th>
<th align="right">arr_delay</th>
<th align="right">gain</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">12.64</td>
<td align="right">6.9</td>
<td align="right">-5.66</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># use a custom function with default na.rm=TRUE</span>
flights_gain <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(dep_delay, arr_delay, gain) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">funs</span>(my_mean)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">kable</span>(<span class="dt">digits=</span><span class="dv">2</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">dep_delay</th>
<th align="right">arr_delay</th>
<th align="right">gain</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">12.64</td>
<td align="right">6.9</td>
<td align="right">-5.66</td>
</tr>
</tbody>
</table>
<p>To practice the <em>tydiverse syntax</em> above, start with data extraction by combining <code>filter()</code>, <code>select()</code>, and <code>arrange()</code>. Then, try summarising data via <code>summarise()</code> and creating new variables via <code>mutate()</code>, followed by adding additional layers of tasks such as grouping statistics via <code>group_by()</code> and filtering data by <code>filter()</code>.</p>
<p><strong>Exercise</strong></p>
<p>Try the following exercises using <code>flights</code> data.</p>
<ul>
<li>Find the set of all origin-carrier combinations whose destination is MSP. Hint: use <code>filter()</code>, <code>select()</code>, and <code>unique()</code>. (Ans.: 10 unique combinations.)</li>
<li>Sort that by origin. Hint: use <code>arrange()</code>.<br />
</li>
<li>Find the mean and standard deviation of air time from New York to MSP. Hint: use <code>filter()</code> and <code>summarise()</code>.</li>
<li>Find the average arrival delay as a percentage of air time from New York to MSP. Hint: use <code>filter()</code>, <code>mutate()</code>, and <code>summarise()</code>. (Ans.: 4.50%.)</li>
<li>Do the above calculation by carrier. Hint: use <code>filter()</code>, <code>mutate()</code>, <code>group_by()</code>, and <code>summarise()</code>. (Ans.: ranges from -3.57% to 4.97%.)</li>
<li>Do the above calculation by origin and carrier and sort the results by origin.</li>
<li>Do that in z-score using the grand mean and grand s.d. to find any origin-carrier combination exhibits statistically significant arrival delay (in percentage of air time). Hint: do the following all inside <code>mutate()</code>, define a percentage arrival delay variable, define variables for its mean and s.d., and define a z-statistic using those three variables. (Ans.: ranges from -0.118 to 1.584.)</li>
</ul>
<!-- ```{r} -->
<!-- flights %>% filter(dest == "MSP") %>%  -->
<!--   mutate(arr_delay_pct = arr_delay/air_time, -->
<!--          avg_arr_delay_pct = mean(arr_delay_pct, na.rm=TRUE), -->
<!--          sd_arr_delay_pct = sd(arr_delay_pct, na.rm=TRUE), -->
<!--          z_arr_delay_pct = (arr_delay_pct -  avg_arr_delay_pct)/sd_arr_delay_pct -->
<!--          ) %>% group_by(origin, carrier) %>% summarise(mean(z_arr_delay_pct, na.rm=T)) %>% arrange(origin) -->
<!-- ``` -->
<p>Take time to do these exercises since we will be using the <em>tydiverse syntax</em> in next section.</p>
</div>
<div id="disqus_thread"></div>
<script>
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//piecemealr.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the
<a href="https://disqus.com/?ref_noscript">
  comments powered by Disqus.</a></noscript>
            </section>

          </div>
        </div>
      </div>
<a href="2-1-materials.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="2-3-arts.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": true,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": {
"link": "https://github.com/kotamine/piecemealR/edit/master/01-Introduction.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection",
"toc": true,
"toc_depth": 3,
"scroll_highlight": true
},
"code_folding": "show",
"highlight": "zenburn",
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
